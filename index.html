<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Buddy - Complete Trading Journal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <style>
        /* Your CSS styles remain unchanged */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        /* ... rest of your CSS ... */
    </style>
</head>
<body>
    <!-- Debug Panel -->
    <div id="debug-panel" class="debug-panel">
        <div id="debug-log">Starting...</div>
    </div>

    <!-- Auth Container -->
    <div id="auth-container" class="auth-container">
        <h1>ðŸ“ˆ Trade Buddy</h1>
        <div class="auth-form">
            <form id="auth-form">
                <input type="email" id="auth-email" class="auth-input" placeholder="Email" required>
                <input type="password" id="auth-password" class="auth-input" placeholder="Password" required>
                <button type="submit" id="auth-submit" class="auth-btn">Sign In</button>
            </form>
            <div class="auth-toggle">
                Don't have an account? <a id="auth-toggle-link">Sign up</a>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="container" id="main-container">
        <!-- Your HTML content remains unchanged -->
        <div class="header">
            <h1>ðŸ“ˆ Trade Buddy</h1>
            <p>Your trusty trading journal to help you take on the markets ðŸ’ª</p>
            <div class="user-info">
                <div class="sync-status">
                    <div class="sync-indicator" id="sync-indicator"></div>
                    <span id="sync-status-text">Synced</span>
                </div>
                <span id="user-email">Loading...</span>
                <button class="logout-btn" id="logout-btn">Logout</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">Dashboard</button>
            <button class="nav-tab" data-tab="add-trade">Add Trade</button>
            <button class="nav-tab" data-tab="trading-plan">Trading Plan</button>
            <button class="nav-tab" data-tab="trades">Trade History</button>
            <button class="nav-tab" data-tab="statistics">Statistics</button>
            <button class="nav-tab" data-tab="calendar">Calendar</button>
            <button class="nav-tab" data-tab="accounts">Accounts</button>
            <button class="nav-tab" data-tab="settings">Settings</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <!-- ... rest of your dashboard HTML ... -->
        </div>

        <!-- Add Trade Tab -->
        <div id="add-trade" class="tab-content">
            <!-- ... rest of your add-trade HTML ... -->
        </div>

        <!-- Trading Plan Tab -->
        <div id="trading-plan" class="tab-content">
            <!-- ... rest of your trading-plan HTML ... -->
        </div>

        <!-- Trade History Tab -->
        <div id="trades" class="tab-content">
            <!-- ... rest of your trades HTML ... -->
        </div>

        <!-- Statistics Tab -->
        <div id="statistics" class="tab-content">
            <!-- ... rest of your statistics HTML ... -->
        </div>

        <!-- Calendar Tab -->
        <div id="calendar" class="tab-content">
            <!-- ... rest of your calendar HTML ... -->
        </div>

        <!-- Accounts Tab -->
        <div id="accounts" class="tab-content">
            <!-- ... rest of your accounts HTML ... -->
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <!-- ... rest of your settings HTML ... -->
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photo-modal" class="photo-modal">
        <span class="close" onclick="closePhotoModal()">&times;</span>
        <div class="photo-modal-content">
            <img id="modal-photo" src="" alt="Trade Photo">
        </div>
    </div>

    <script>
        // Debug logging
        let debugLog = [];
        function debug(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            debugLog.push(logMessage);
            const debugPanel = document.getElementById('debug-log');
            if (debugPanel) {
                debugPanel.innerHTML = debugLog.slice(-8).join('<br>');
            }
        }

        // Configuration
        const SUPABASE_URL = 'https://drmgbjqdlmmtvkdxyqxf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRybWdianFkbG1tdHZrZHh5cXhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyMjUwMTEsImV4cCI6MjA2OTgwMTAxMX0.B7hZkBv7Yv6cWjjM8wYo2VWSx8paLzv7k9WSQXjehdM';

        // Global variables
        let supabaseClient = null;
        let user = null;
        let isSignUp = false;
        let trades = [];
        let accounts = [];
        let syncStatus = 'synced';
        let currentPhotos = [];
        let tradingPlan = {};
        let currentCalendarDate = new Date();

        debug('âœ… Variables initialized');

        // Save trade function
        async function saveTrade(e) {
            e.preventDefault();
            debug('ðŸ’¾ Saving trade...');
            updateSyncStatus('syncing');
            try {
                const accountId = document.getElementById('trade-account').value;
                if (!accountId) {
                    showNotification('Please select an account', 'error');
                    updateSyncStatus('synced');
                    return;
                }
                const trade = {
                    user_id: user.id,
                    account_id: parseInt(accountId),
                    date: document.getElementById('date').value,
                    symbol: document.getElementById('symbol').value.toUpperCase(),
                    side: document.getElementById('side').value,
                    quantity: parseFloat(document.getElementById('quantity').value),
                    entry_price: parseFloat(document.getElementById('entry-price').value),
                    exit_price: document.getElementById('exit-price').value ? parseFloat(document.getElementById('exit-price').value) : null,
                    manual_pnl: document.getElementById('manual-pnl').value ? parseFloat(document.getElementById('manual-pnl').value) : null,
                    commission: document.getElementById('commission').value ? parseFloat(document.getElementById('commission').value) : 0,
                    swap: document.getElementById('swap').value ? parseFloat(document.getElementById('swap').value) : 0,
                    stop_loss: document.getElementById('stop-loss').value ? parseFloat(document.getElementById('stop-loss').value) : null,
                    take_profit: document.getElementById('take-profit').value ? parseFloat(document.getElementById('take-profit').value) : null,
                    strategy: document.getElementById('strategy').value,
                    market_condition: document.getElementById('market-condition').value,
                    risk_rating: document.getElementById('risk-rating').value,
                    confidence: document.getElementById('confidence').value,
                    followed_plan: document.getElementById('followed-plan').checked,
                    setup_description: document.getElementById('setup-description').value,
                    emotions: document.getElementById('emotions').value,
                    lessons: document.getElementById('lessons').value,
                    photos: [...currentPhotos],
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                if (trade.exit_price) {
                    if (trade.manual_pnl !== null) {
                        trade.pnl = trade.manual_pnl;
                    } else {
                        let pnl = 0;
                        if (trade.side === 'Long') {
                            pnl = (trade.exit_price - trade.entry_price) * trade.quantity;
                        } else {
                            pnl = (trade.entry_price - trade.exit_price) * trade.quantity;
                        }
                        const symbol = trade.symbol.toUpperCase();
                        const forexPairs = ['USD', 'EUR', 'GBP', 'JPY', 'AUD', 'NZD', 'CAD', 'CHF'];
                        const isLikelyForex = forexPairs.some(currency => symbol.includes(currency)) && symbol.length >= 6;
                        if (isLikelyForex) {
                            if (symbol.includes('JPY')) {
                                pnl = pnl * 1000;
                            } else {
                                pnl = pnl * 100000;
                            }
                        }
                        trade.pnl = pnl;
                    }
                    trade.gross_pnl = trade.pnl;
                    trade.pnl = trade.pnl - (trade.commission || 0) - (trade.swap || 0);
                    trade.status = trade.pnl >= 0 ? 'Closed - Profit' : 'Closed - Loss';
                } else {
                    trade.pnl = 0;
                    trade.status = 'Open';
                }
                const { data, error } = await supabaseClient
                    .from('trades')
                    .insert(trade)
                    .select()
                    .single();
                if (error) throw error;
                trades.unshift(data);
                if (trade.exit_price) {
                    const account = accounts.find(acc => acc.id === trade.account_id);
                    if (account) {
                        const newBalance = (account.current_balance || 0) + trade.pnl;
                        const { error: accountError } = await supabaseClient
                            .from('accounts')
                            .update({ 
                                current_balance: newBalance,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', trade.account_id)
                            .eq('user_id', user.id);
                        if (!accountError) {
                            account.current_balance = newBalance;
                        }
                    }
                }
                updateDashboard();
                updateTradesDisplay();
                updateAccountList();
                updateStatistics();
                document.getElementById('trade-form').reset();
                currentPhotos = [];
                updatePhotoPreview();
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('date').value = now.toISOString().slice(0, 16);
                updateSyncStatus('synced');
                showNotification('Trade saved successfully!', 'success');
            } catch (error) {
                debug(`âŒ Error saving trade: ${error.message}`);
                updateSyncStatus('error');
                showNotification(`Error saving trade: ${error.message}`, 'error');
            }
        }

        // Global functions for onclick events
        window.showAddAccountForm = () => {
            const form = document.getElementById('add-account-form');
            if (form) form.style.display = 'block';
        };

        window.cancelAddAccount = () => {
            const form = document.getElementById('add-account-form');
            if (form) form.style.display = 'none';
            clearAccountForm();
        };

        window.addAccount = async () => {
            const name = document.getElementById('new-account-name').value.trim();
            const balance = parseFloat(document.getElementById('new-account-balance').value);
            if (!name) {
                showNotification('Account name is required', 'error');
                return;
            }
            if (isNaN(balance) || balance < 0) {
                showNotification('Valid starting balance is required', 'error');
                return;
            }
            updateSyncStatus('syncing');
            try {
                const account = {
                    user_id: user.id,
                    name: name,
                    type: document.getElementById('new-account-type').value,
                    broker: document.getElementById('new-account-broker').value,
                    currency: document.getElementById('new-account-currency').value,
                    starting_balance: balance,
                    current_balance: balance,
                    created_at: new Date().toISOString()
                };
                const { data, error } = await supabaseClient
                    .from('accounts')
                    .insert(account)
                    .select()
                    .single();
                if (error) throw error;
                accounts.push(data);
                updateAccountList();
                updateDashboard();
                clearAccountForm();
                document.getElementById('add-account-form').style.display = 'none';
                updateSyncStatus('synced');
                showNotification('Account added successfully', 'success');
            } catch (error) {
                debug(`âŒ Error adding account: ${error.message}`);
                updateSyncStatus('error');
                showNotification(`Error adding account: ${error.message}`, 'error');
            }
        };

        function clearAccountForm() {
            document.getElementById('new-account-name').value = '';
            document.getElementById('new-account-type').value = 'Cash';
            document.getElementById('new-account-broker').value = '';
            document.getElementById('new-account-currency').value = 'USD';
            document.getElementById('new-account-balance').value = '';
        }

        // ... Include all other JavaScript functions here (deleteAccount, deleteTrade, openPhotoModal, etc.) ...
        // For brevity, I've omitted the rest, but they should be placed here in the <script> block.
        // Let me know if you need the full script with all functions included.

        // Initialize the application
        async function initApp() {
            debug('ðŸš€ Initializing application...');
            try {
                await new Promise(resolve => setTimeout(resolve, 100));
                const supabaseReady = await initSupabase();
                if (!supabaseReady) {
                    debug('âŒ Supabase initialization failed');
                    return;
                }
                const authReady = setupAuth();
                if (!authReady) {
                    debug('âŒ Auth setup failed');
                    return;
                }
                setupAuthListener();
                debug('âœ… Application initialization complete');
            } catch (error) {
                debug(`ðŸ’¥ Fatal initialization error: ${error.message}`);
                showNotification(`Fatal error: ${error.message}`, 'error');
            }
        }

        // ... Include all other functions (showNotification, updateSyncStatus, initSupabase, etc.) ...

        // DOM ready event
        document.addEventListener('DOMContentLoaded', () => {
            debug('ðŸ“„ DOM Content Loaded');
            setTimeout(() => {
                debug('ðŸš€ Starting app initialization...');
                initApp();
            }, 100);
        });

        if (document.readyState === 'loading') {
            debug('ðŸ“„ Document still loading...');
        } else {
            debug('ðŸ“„ Document already loaded');
            setTimeout(() => {
                debug('ðŸš€ Starting immediate initialization...');
                initApp();
            }, 100);
        }

        debug('ðŸ“œ Enhanced Trade Buddy script setup complete');
    </script>
</body>
</html>
