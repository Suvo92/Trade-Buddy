<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trade Journal — Minimal Single File</title>
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --muted:#6b7280; --accent:#1062ff;
    --success:#16a34a; --danger:#ef4444; --radius:12px; --glass: rgba(255,255,255,0.7);
    --max-width:1100px;
  }
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  body{background:linear-gradient(180deg,#eef2ff 0%,var(--bg) 60%);display:flex;align-items:flex-start;justify-content:center;padding:28px;}
  .app{width:100%;max-width:var(--max-width);background:var(--card);border-radius:18px;box-shadow:0 8px 30px rgba(16,24,40,0.08);overflow:hidden;}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid #eef2ff;background:linear-gradient(90deg,#fff,#fbfdff);}
  header h1{font-size:18px;margin:0;color:#0f172a;font-weight:600;display:flex;align-items:center;gap:10px}
  .layout{display:grid;grid-template-columns:320px 1fr;gap:20px;padding:20px;}
  @media (max-width:900px){ .layout{grid-template-columns:1fr; padding:12px;} .left{order:2} .right{order:1} }
  .left{min-width:240px}
  .card{background:var(--card);border-radius:12px;padding:14px;border:1px solid #f1f5f9;}
  .section-title{font-weight:700;margin:0 0 10px 0;color:#0f172a;font-size:13px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="text"],input[type="number"],select,textarea,input[type="datetime-local"]{
    width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef8;background:transparent;font-size:14px;color:#0f172a;
  }
  textarea{min-height:70px;resize:vertical}
  .btn{display:inline-flex;align-items:center;gap:8px;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn-primary{background:linear-gradient(90deg,var(--accent),#0b5bff);color:white;box-shadow:0 6px 18px rgba(11,91,255,0.12)}
  .btn-ghost{background:transparent;border:1px solid #e6eef8;color:var(--accent)}
  .btn-danger{background:var(--danger);color:white}
  .small{font-size:13px;padding:6px 10px}
  .muted{color:var(--muted);font-size:13px}
  .spaced{display:flex;gap:10px;flex-wrap:wrap}
  .account-list{display:flex;flex-direction:column;gap:8px}
  .account-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;background:linear-gradient(180deg,#ffffff,#fbfdff);border:1px solid #f1f5f9}
  .account-item .meta{font-size:13px;color:var(--muted)}
  .kpi-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .kpi{padding:12px;border-radius:8px;background:#fbfdff;border:1px solid #f1f5f9}
  .kpi .v{font-weight:700;font-size:18px;color:#0f172a}
  .photo-preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .photo-thumb{width:64px;height:48px;border-radius:6px;overflow:hidden;border:1px solid #e6eef8;display:inline-block;cursor:pointer}
  .pbottom{margin-top:12px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px dashed #f1f5f9;text-align:left}
  th{font-weight:700;color:var(--muted);font-size:12px}
  .profit{color:var(--success);font-weight:700}
  .loss{color:var(--danger);font-weight:700}
  .tiny{font-size:12px;color:var(--muted)}
  footer{padding:12px 20px;text-align:center;font-size:12px;color:var(--muted);border-top:1px solid #f1f5f9}
  .flex{display:flex;gap:10px;align-items:center}
  .right-col{display:grid;gap:14px}
  .top-row{display:flex;gap:14px;align-items:stretch}
  .grow{flex:1}
  .plan-textarea{height:110px}
  /* profit target card */
  .profit-target{padding:12px;border-radius:12px;background:linear-gradient(90deg,#fff8dc,#fff1b8);position:relative;overflow:hidden}
  .progress{height:10px;background:rgba(0,0,0,0.06);border-radius:999px;overflow:hidden}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,#16a34a,#2dd4bf);width:0%}
  .achievement{position:absolute;right:12px;top:10px;font-weight:800;color:#b45309}
  /* accessible focus */
  input:focus,select:focus,textarea:focus,.btn:focus{outline:3px solid rgba(16,98,255,0.12);outline-offset:2px}
  /* table responsive */
  .scroll-x{overflow:auto}
</style>
</head>
<body>
<div class="app" role="application" aria-labelledby="app-title">
  <header>
    <h1 id="app-title">📓 Trade Journal — Single File</h1>
    <div class="flex small">
      <div id="storage-status" class="muted" aria-live="polite">Data: localStorage</div>
      <button class="btn btn-ghost small" id="btn-export-json" title="Export backup (JSON)">Export</button>
      <button class="btn btn-ghost small" id="btn-import-json" title="Import backup (JSON)">Import</button>
    </div>
  </header>

  <div class="layout" role="main">
    <!-- LEFT: accounts, profit target, trading plan -->
    <aside class="left">
      <div class="card" aria-labelledby="accounts-title">
        <h2 id="accounts-title" class="section-title">Accounts</h2>
        <div class="account-list" id="account-list" aria-live="polite"></div>

        <div style="margin-top:10px" aria-hidden="false">
          <label for="acc-name">Name</label>
          <input id="acc-name" type="text" placeholder="Broker / Account name" />
          <label for="acc-currency" class="pbottom">Currency</label>
          <select id="acc-currency">
            <option value="USD">USD</option><option value="EUR">EUR</option><option value="JPY">JPY</option><option value="GBP">GBP</option>
          </select>
          <label for="acc-balance">Starting Balance</label>
          <input id="acc-balance" type="number" inputmode="decimal" placeholder="10000" />
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn btn-primary" id="btn-add-account">Add Account</button>
            <button class="btn" id="btn-clear-accounts">Clear</button>
          </div>
        </div>
      </div>

      <div class="card pbottom" style="margin-top:14px" aria-labelledby="profit-title">
        <h2 id="profit-title" class="section-title">Profit Target</h2>
        <div class="profit-target" id="profit-target-card" role="region" aria-live="polite">
          <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
            <div>
              <div class="tiny">Current</div>
              <div style="font-weight:800;font-size:18px" id="profit-current">+$0</div>
              <div class="tiny" id="profit-goal-text">of $0 target</div>
            </div>
            <div style="text-align:right">
              <div class="tiny">Progress</div>
              <div style="width:160px"><div class="progress" aria-hidden="true"><i id="profit-bar"></i></div></div>
              <div class="tiny" id="profit-percent">0%</div>
            </div>
          </div>
          <div class="achievement" id="profit-achieve" hidden>🎉</div>
        </div>

        <div style="margin-top:10px">
          <label for="target-enabled"><input id="target-enabled" type="checkbox" /> Enable tracking</label>
          <label for="target-amount">Target Amount</label>
          <input id="target-amount" type="number" inputmode="decimal" placeholder="1000" />
          <label for="target-period" class="pbottom">Period</label>
          <select id="target-period">
            <option value="monthly">Monthly</option>
            <option value="quarterly">Quarterly</option>
            <option value="yearly">Yearly</option>
            <option value="all-time">All-time</option>
          </select>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn btn-primary small" id="save-target">Save</button>
            <button class="btn small" id="reset-target">Reset</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px" aria-labelledby="plan-title">
        <h2 id="plan-title" class="section-title">Trading Plan</h2>
        <label for="plan-entry">Entry criteria</label>
        <textarea id="plan-entry" class="plan-textarea" placeholder="Entry rules..."></textarea>
        <label for="plan-exit">Exit / Risk</label>
        <textarea id="plan-exit" class="plan-textarea" placeholder="Exit & risk rules..."></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn btn-primary" id="save-plan">Save Plan</button>
          <button class="btn" id="clear-plan">Clear</button>
        </div>
      </div>
    </aside>

    <!-- RIGHT: trade entry, history, stats, backup -->
    <section class="right grow" aria-labelledby="entry-title">
      <div class="right-col">
        <div class="card top-row" style="align-items:flex-start">
          <!-- Trade Entry -->
          <div style="flex:1;min-width:280px" aria-labelledby="entry-title">
            <h2 id="entry-title" class="section-title">New Trade</h2>
            <form id="trade-form" aria-describedby="trade-help">
              <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
                <div>
                  <label for="trade-account">Account</label>
                  <select id="trade-account" required><option value="">— pick an account —</option></select>
                </div>
                <div>
                  <label for="trade-date">Date / Time</label>
                  <input id="trade-date" type="datetime-local" />
                </div>
                <div>
                  <label for="symbol">Symbol</label>
                  <input id="symbol" type="text" placeholder="AAPL or EURUSD" required />
                </div>
                <div>
                  <label for="side">Side</label>
                  <select id="side"><option value="Long">Long</option><option value="Short">Short</option></select>
                </div>
                <div>
                  <label for="qty">Quantity</label>
                  <input id="qty" type="number" step="0.01" placeholder="1.0 (lots) or shares" />
                </div>
                <div>
                  <label for="entry-price">Entry Price</label>
                  <input id="entry-price" type="number" step="0.00001" />
                </div>
                <div>
                  <label for="exit-price">Exit Price</label>
                  <input id="exit-price" type="number" step="0.00001" />
                </div>
                <div>
                  <label for="manual-pnl">Manual P&L (optional)</label>
                  <input id="manual-pnl" type="number" step="0.01" />
                </div>
                <div>
                  <label for="commission">Commission</label>
                  <input id="commission" type="number" step="0.01" placeholder="0" />
                </div>
                <div>
                  <label for="swap">Swap / Interest</label>
                  <input id="swap" type="number" step="0.01" placeholder="0" />
                </div>
              </div>

              <label for="strategy">Strategy (optional)</label>
              <input id="strategy" type="text" placeholder="Breakout, Swing..." />

              <label for="followed-plan" class="pbottom"><input id="followed-plan" type="checkbox" /> Followed trading plan?</label>

              <label for="notes">Notes / Lessons</label>
              <textarea id="notes" placeholder="What happened? Lessons..."></textarea>

              <!-- photo upload with auto-resize -->
              <label for="photo-input" class="pbottom">Photos / screenshots (will be resized)</label>
              <input id="photo-input" type="file" accept="image/*" multiple />
              <div class="photo-preview" id="photo-preview" aria-live="polite"></div>

              <div style="display:flex;gap:8px;margin-top:10px">
                <button type="submit" class="btn btn-primary">Save Trade</button>
                <button type="button" id="btn-calc" class="btn">Calc P&L</button>
                <button type="button" id="btn-clear-trade" class="btn">Clear</button>
              </div>
              <div id="trade-help" class="tiny muted" style="margin-top:8px">P&L auto-calculated unless you enter Manual P&L. Forex pairs use a simplified scaling (use Manual P&L for exact amounts).</div>
            </form>
          </div>

          <!-- Stats / KPIs -->
          <div style="width:320px" aria-labelledby="stats-title">
            <h2 id="stats-title" class="section-title">Statistics</h2>
            <div class="kpi-grid" aria-live="polite">
              <div class="kpi"><div class="v" id="stat-total">0</div><div class="tiny">Total trades</div></div>
              <div class="kpi"><div class="v" id="stat-winrate">0%</div><div class="tiny">Win rate</div></div>
              <div class="kpi"><div class="v" id="stat-totalpnl">$0</div><div class="tiny">Total P&L</div></div>
              <div class="kpi"><div class="v" id="stat-profitfactor">0</div><div class="tiny">Profit factor</div></div>
              <div class="kpi"><div class="v" id="stat-avgwin">$0</div><div class="tiny">Avg win</div></div>
              <div class="kpi"><div class="v" id="stat-avgloss">$0</div><div class="tiny">Avg loss</div></div>
              <div class="kpi"><div class="v" id="stat-largestwin">$0</div><div class="tiny">Largest win</div></div>
              <div class="kpi"><div class="v" id="stat-largestloss">$0</div><div class="tiny">Largest loss</div></div>
              <div class="kpi" style="grid-column:1/-1"><div class="v" id="stat-expectancy">$0</div><div class="tiny">Expectancy per trade</div></div>
            </div>
          </div>
        </div>

        <!-- Trade History and backup -->
        <div class="card scroll-x" aria-labelledby="history-title">
          <h2 id="history-title" class="section-title">Trade History</h2>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <input id="filter-symbol" type="text" placeholder="filter symbol..." />
            <select id="filter-account">
              <option value="">All accounts</option>
            </select>
            <select id="filter-outcome">
              <option value="">All</option><option value="profit">Profit</option><option value="loss">Loss</option><option value="open">Open</option>
            </select>
            <button id="export-csv" class="btn btn-ghost small">CSV</button>
            <button id="clear-data" class="btn btn-danger small">Clear all data</button>
          </div>

          <table id="trades-table" aria-live="polite">
            <thead><tr><th>Date</th><th>Acct</th><th>Symbol</th><th>Side</th><th>Qty</th><th>Entry</th><th>Exit</th><th>P&L</th><th>Notes</th><th>Photos</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card" aria-labelledby="backup-title">
          <h2 id="backup-title" class="section-title">Backup & Settings</h2>
          <div class="spaced">
            <button id="btn-export" class="btn btn-primary">Export JSON</button>
            <input id="import-file" type="file" accept=".json" style="display:none" />
            <button id="btn-import" class="btn">Import JSON</button>
            <button id="btn-fix-bal" class="btn">Recalc account balances</button>
          </div>
          <div style="margin-top:10px" class="tiny muted">Photos are base64 in export — large backups may be big. The app auto-resizes photos to limit size.</div>
        </div>

      </div>
    </section>
  </div>

  <footer>
    Built with ❤️ • Single-file — stores data in your browser only
  </footer>
</div>

<script>
/*
  Trade Journal - Single HTML file
  - No external libraries
  - Data stored in localStorage under key 'tj_data_v1'
  - Photos resized in-browser to limit size (max 1200px)
  - Profit target tracked by period (monthly/quarterly/yearly/all-time)
  - Stats updated live
  - Accessible labels, small footprint
*/

/* -------------------------
   Storage & data utilities
   ------------------------- */
const STORAGE_KEY = 'tj_data_v1';

function loadData(){
  try{
    return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { accounts:[], trades:[], plan:{}, profitTarget:{ enabled:false, amount:0, period:'monthly' } };
  }catch(e){
    console.error('load error',e); return { accounts:[], trades:[], plan:{}, profitTarget:{ enabled:false, amount:0, period:'monthly' } };
  }
}
function saveData(state){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  document.getElementById('storage-status').textContent = `Data: localStorage • ${new Date().toLocaleString()}`;
}

/* -------------------------
   App state
   ------------------------- */
let state = loadData();

/* -------------------------
   Helpers
   ------------------------- */
function $(id){return document.getElementById(id);}
function formatMoney(v){ 
  const n = Number(v) || 0; 
  const sign = n<0?'-':''; 
  return sign + '$' + Math.abs(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
}
function safeNum(v, fallback=0){ const n = Number(v); return isNaN(n)?fallback:n; }

/* -------------------------
   Image resizing (client) 
   - Resizes to max dimension 1200px, quality ~0.7
   - returns base64 dataurl
   ------------------------- */
async function resizeImageFile(file, maxDim=1200, quality=0.75){
  return new Promise((resolve, reject)=>{
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => {
      img.onload = ()=>{
        let w = img.width, h = img.height;
        const ratio = Math.min(1, maxDim / Math.max(w,h));
        w = Math.round(w * ratio); h = Math.round(h * ratio);
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img,0,0,w,h);
        try{
          const dataUrl = canvas.toDataURL('image/jpeg', quality);
          resolve(dataUrl);
        }catch(err){
          reject(err);
        }
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* -------------------------
   Account management
   ------------------------- */
function renderAccounts(){
  const list = $('account-list'); list.innerHTML = '';
  if(state.accounts.length===0){
    list.innerHTML = '<div class="tiny muted">No accounts yet</div>';
  }else{
    state.accounts.forEach(acc=>{
      const el = document.createElement('div'); el.className='account-item';
      el.innerHTML = `<div>
        <div style="font-weight:700">${acc.name}</div>
        <div class="meta tiny">${acc.currency} • Start ${formatMoney(acc.starting_balance)}</div>
      </div>
      <div style="display:flex;gap:6px">
        <div class="meta tiny" style="min-width:80px;text-align:right">${acc.current_balance!==undefined?formatMoney(acc.current_balance):'—'}</div>
        <button class="btn small" data-id="${acc.id}" onclick="editAccount(event)">Edit</button>
        <button class="btn small" data-id="${acc.id}" onclick="deleteAccount(event)">Del</button>
      </div>`;
      list.appendChild(el);
    });
  }
  // update selects
  const tradeAcc = $('trade-account'); tradeAcc.innerHTML = '<option value="">— pick an account —</option>';
  const filterAcc = $('filter-account'); filterAcc.innerHTML = '<option value="">All accounts</option>';
  const dashboardAcc = $('dashboard-account-selector');
  [tradeAcc,filterAcc,dashboardAcc].forEach(sel=>{
    state.accounts.forEach(a=> sel.insertAdjacentHTML('beforeend',`<option value="${a.id}">${a.name}</option>`));
  });
}
function addAccount(){
  const name = $('acc-name').value.trim();
  const currency = $('acc-currency').value;
  const sb = safeNum($('acc-balance').value,0);
  if(!name){ alert('Account name required'); return; }
  const id = Date.now().toString();
  const acc = { id, name, currency, starting_balance:sb, current_balance:sb, created_at: new Date().toISOString() };
  state.accounts.push(acc);
  saveData(state); renderAccounts(); $('acc-name').value=''; $('acc-balance').value='';
}
function deleteAccount(e){
  const id = e.currentTarget.dataset.id;
  if(!confirm('Delete account and its trades?')) return;
  state.accounts = state.accounts.filter(a=>a.id!==id);
  // also delete trades tied to that account
  state.trades = state.trades.filter(t=>t.account_id!==id);
  saveData(state); renderAccounts(); renderTrades(); updateStats(); 
}
function editAccount(e){
  const id = e.currentTarget.dataset.id;
  const acc = state.accounts.find(a=>a.id===id);
  if(!acc) return;
  const newName = prompt('Account name',acc.name);
  if(newName!==null){ acc.name = newName.trim() || acc.name; saveData(state); renderAccounts(); renderTrades(); updateStats(); }
}
function clearAccounts(){
  if(!confirm('Clear all accounts? This also removes related trades.')) return;
  state.accounts=[]; state.trades=[]; saveData(state); renderAccounts(); renderTrades(); updateStats();
}
window.addAccount = addAccount;
window.deleteAccount = deleteAccount;
window.editAccount = editAccount;
window.clearAccounts = clearAccounts;
$('btn-add-account').addEventListener('click',addAccount);
$('btn-clear-accounts').addEventListener('click',clearAccounts);

/* -------------------------
   Profit target
   ------------------------- */
function loadProfitTargetUI(){
  const pt = state.profitTarget || { enabled:false, amount:0, period:'monthly'};
  $('target-enabled').checked = !!pt.enabled;
  $('target-amount').value = pt.amount || '';
  $('target-period').value = pt.period || 'monthly';
  updateProfitUI();
}
function saveProfitTarget(){
  state.profitTarget = { enabled: !!$('target-enabled').checked, amount: safeNum($('target-amount').value,0), period:$('target-period').value };
  saveData(state); updateProfitUI();
  alert('Profit target saved');
}
function resetProfitTarget(){
  state.profitTarget = { enabled:false, amount:0, period:'monthly' }; saveData(state); loadProfitTargetUI();
}
function updateProfitUI(){
  const pt = state.profitTarget || { enabled:false, amount:0, period:'monthly' };
  const enabled = !!pt.enabled && pt.amount>0;
  const current = calcProfitForPeriod(pt.period);
  $('profit-current').textContent = (current>=0?'+':'') + current.toFixed(2);
  $('profit-goal-text').textContent = `of ${pt.amount.toLocaleString()} target (${pt.period})`;
  const percent = pt.amount>0? Math.min(100, Math.max(0, current/pt.amount*100)) : 0;
  $('profit-bar').style.width = percent + '%';
  $('profit-percent').textContent = percent.toFixed(1) + '%';
  $('profit-achieve').hidden = current < pt.amount;
  $('profit-target-card').style.display = enabled ? 'block' : 'none';
}
function calcProfitForPeriod(period){
  const now = new Date();
  const closed = state.trades.filter(t => t.exit_price !== null && t.exit_price !== undefined && t.status && (t.status.includes('Closed') || t.status.startsWith('Closed')));
  let total = 0;
  closed.forEach(t=>{
    const d = new Date(t.date);
    let include = false;
    if(period==='monthly') include = (d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear());
    else if(period==='quarterly'){ const q = Math.floor(d.getMonth()/3); const nq = Math.floor(now.getMonth()/3); include = q===nq && d.getFullYear()===now.getFullYear();}
    else if(period==='yearly') include = d.getFullYear()===now.getFullYear();
    else include = true;
    if(include) total += safeNum(t.pnl,0);
  });
  return Math.round(total*100)/100;
}
$('save-target').addEventListener('click',saveProfitTarget);
$('reset-target').addEventListener('click',resetProfitTarget);

/* -------------------------
   Trading plan
   ------------------------- */
function loadPlanUI(){
  $('plan-entry').value = state.plan?.entry || '';
  $('plan-exit').value = state.plan?.exit || '';
}
function savePlan(){
  state.plan = { entry: $('plan-entry').value, exit: $('plan-exit').value, updated_at: new Date().toISOString() };
  saveData(state); alert('Plan saved');
}
function clearPlan(){ if(!confirm('Clear trading plan?')) return; state.plan={}; saveData(state); loadPlanUI(); }
$('save-plan').addEventListener('click',savePlan);
$('clear-plan').addEventListener('click',clearPlan);

/* -------------------------
   Trade entry / calculation
   ------------------------- */
function resetTradeForm(){
  $('trade-form').reset();
  $('photo-preview').innerHTML='';
  currentPhotos = [];
  // set date default now
  const dt = new Date(); dt.setMinutes(dt.getMinutes()-dt.getTimezoneOffset());
  $('trade-date').value = dt.toISOString().slice(0,16);
}
let currentPhotos = [];
$('photo-input').addEventListener('change', async (ev)=>{
  const files = Array.from(ev.target.files||[]);
  for(const f of files){
    if(!f.type.startsWith('image/')) continue;
    try{
      // resize and store base64
      const dataUrl = await resizeImageFile(f, 1200, 0.75);
      currentPhotos.push({ id: Date.now().toString()+Math.random().toString(36).slice(2,8), data:dataUrl, name:f.name });
      renderPhotoPreview();
    }catch(err){
      console.warn('image resize failed',err);
    }
  }
  ev.target.value=''; // allow re-upload same
});
function renderPhotoPreview(){
  const cont = $('photo-preview'); cont.innerHTML='';
  currentPhotos.forEach(p=>{
    const d = document.createElement('div'); d.className='photo-thumb';
    d.innerHTML = `<img src="${p.data}" alt="${p.name}" style="width:100%;height:100%;object-fit:cover" />`;
    d.addEventListener('click',()=>window.open(p.data,'_blank'));
    cont.appendChild(d);
  });
}

/* P&L calculation:
   - If manual_pnl provided -> use that
   - else compute (exit-entry)*qty for long, reverse for short
   - For forex pairs (simple heuristic): if symbol length >=6 and contains known currencies, scale by lot size:
       JPY pairs multiply by 1000 (approx); others multiply by 100000 (approx)
   - Subtract commission and swap
*/
function calculatePnLObj(inputs){
  // inputs: { symbol, side, quantity, entry_price, exit_price, manual_pnl, commission, swap }
  const manual = inputs.manual_pnl;
  if(manual !== null && manual !== undefined && manual !== ''){
    const pnl = safeNum(manual,0) - safeNum(inputs.commission,0) - safeNum(inputs.swap,0);
    return { pnl, gross: safeNum(manual,0) };
  }
  const entry = safeNum(inputs.entry_price,0);
  const exit = safeNum(inputs.exit_price, null);
  if(exit===null) return { pnl:0, gross:0 }; // open trade
  const qty = safeNum(inputs.quantity,1);
  let raw = 0;
  if(inputs.side === 'Long'){ raw = (exit - entry) * qty; } else { raw = (entry - exit) * qty; }

  // simple forex heuristic
  const sym = (inputs.symbol||'').toUpperCase();
  const forexPairs = ['USD','EUR','GBP','JPY','AUD','NZD','CAD','CHF'];
  const isForex = sym.length>=6 && forexPairs.some(c=>sym.includes(c));
  if(isForex){
    if(sym.includes('JPY')) raw = raw * 1000;
    else raw = raw * 100000;
  }
  const gross = raw;
  const pnl = gross - safeNum(inputs.commission,0) - safeNum(inputs.swap,0);
  return { pnl: Math.round(pnl*100)/100, gross: Math.round(gross*100)/100 };
}

/* Save trade */
$('trade-form').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const account_id = $('trade-account').value;
  if(!account_id){ alert('Choose an account'); return; }
  const t = {
    id: Date.now().toString(),
    account_id,
    date: $('trade-date').value || new Date().toISOString(),
    symbol: $('symbol').value.toUpperCase(),
    side: $('side').value,
    quantity: safeNum($('qty').value,1),
    entry_price: $('entry-price').value ? safeNum($('entry-price').value) : null,
    exit_price: $('exit-price').value ? safeNum($('exit-price').value) : null,
    manual_pnl: $('manual-pnl').value ? safeNum($('manual-pnl').value) : null,
    commission: $('commission').value ? safeNum($('commission').value):0,
    swap: $('swap').value ? safeNum($('swap').value):0,
    strategy: $('strategy').value,
    followed_plan: !!$('followed-plan').checked,
    notes: $('notes').value,
    photos: currentPhotos.slice(),
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  };
  // compute P&L & status
  const pnlObj = calculatePnLObj(t);
  t.gross_pnl = pnlObj.gross;
  t.pnl = pnlObj.pnl;
  t.status = (t.exit_price!==null && t.exit_price!==undefined) ? (t.pnl>=0 ? 'Closed - Profit' : 'Closed - Loss') : 'Open';
  state.trades.unshift(t);
  // update account balance if closed
  if(t.exit_price!==null && t.exit_price!==undefined){
    const acc = state.accounts.find(a=>a.id===account_id);
    if(acc){
      acc.current_balance = safeNum(acc.current_balance,0) + t.pnl;
    }
  }
  saveData(state);
  resetTradeForm(); renderAccounts(); renderTrades(); updateStats(); updateProfitUI();
  alert('Trade saved');
});

/* quick calc button */
$('btn-calc').addEventListener('click', ()=>{
  const inputs = {
    symbol: $('symbol').value, side:$('side').value, quantity:safeNum($('qty').value,1),
    entry_price: $('entry-price').value?safeNum($('entry-price').value):null,
    exit_price: $('exit-price').value?safeNum($('exit-price').value):null,
    manual_pnl: $('manual-pnl').value?safeNum($('manual-pnl').value):null,
    commission: $('commission').value?safeNum($('commission').value):0,
    swap: $('swap').value?safeNum($('swap').value):0
  };
  const res = calculatePnLObj(inputs);
  alert(`Gross: ${res.gross}\nNet P&L: ${res.pnl}`);
});

/* Clear trade form */
$('btn-clear-trade').addEventListener('click', resetTradeForm);

/* -------------------------
   Render trade history
   ------------------------- */
function renderTrades(filter={}){
  const tbody = document.querySelector('#trades-table tbody'); tbody.innerHTML = '';
  let rows = state.trades.slice(); // copy
  // apply filters
  const fSymbol = $('filter-symbol').value.trim().toUpperCase();
  if(fSymbol) rows = rows.filter(r => (r.symbol||'').toUpperCase().includes(fSymbol));
  const fAcc = $('filter-account').value; if(fAcc) rows = rows.filter(r=>r.account_id===fAcc);
  const fOutcome = $('filter-outcome').value;
  if(fOutcome==='profit') rows = rows.filter(r=>safeNum(r.pnl,0)>0);
  if(fOutcome==='loss') rows = rows.filter(r=>safeNum(r.pnl,0)<0);
  if(fOutcome==='open') rows = rows.filter(r=>!(r.exit_price!==null && r.exit_price!==undefined));
  rows.forEach(t=>{
    const acc = state.accounts.find(a=>a.id===t.account_id);
    const tr = document.createElement('tr');
    const photosHtml = (t.photos||[]).slice(0,3).map(p=>`<img src="${p.data}" alt="${p.name}" style="width:28px;height:22px;object-fit:cover;border-radius:4px;margin-right:4px" />`).join('');
    tr.innerHTML = `<td>${new Date(t.date).toLocaleString()}</td>
      <td>${acc?acc.name:'Unknown'}</td>
      <td><strong>${t.symbol}</strong></td>
      <td>${t.side}</td>
      <td>${t.quantity}</td>
      <td>${t.entry_price!==null?t.entry_price:''}</td>
      <td>${t.exit_price!==null?t.exit_price:''}</td>
      <td class="${(t.pnl||0)>=0?'profit':'loss'}">${(t.pnl||0)>=0?'+':''}${(t.pnl||0).toFixed(2)}</td>
      <td class="tiny">${(t.notes||'').slice(0,100)}</td>
      <td>${photosHtml}</td>
      <td><button class="btn small" data-id="${t.id}" onclick="deleteTrade(event)">Del</button></td>`;
    tbody.appendChild(tr);
  });
  // populate account filter select
  const filterAcc = $('filter-account'); filterAcc.innerHTML = '<option value="">All accounts</option>';
  state.accounts.forEach(a=>filterAcc.insertAdjacentHTML('beforeend',`<option value="${a.id}">${a.name}</option>`));
}
window.deleteTrade = function(e){
  const id = e.currentTarget.dataset.id;
  if(!confirm('Delete trade?')) return;
  const t = state.trades.find(tt=>tt.id===id);
  if(t && (t.exit_price!==null && t.exit_price!==undefined)){
    // adjust account balance
    const acc = state.accounts.find(a=>a.id===t.account_id);
    if(acc) acc.current_balance = safeNum(acc.current_balance,0) - safeNum(t.pnl,0);
  }
  state.trades = state.trades.filter(tt=>tt.id!==id);
  saveData(state); renderTrades(); renderAccounts(); updateStats(); updateProfitUI();
};

/* filters */
$('filter-symbol').addEventListener('input', ()=>renderTrades());
$('filter-account').addEventListener('change', ()=>renderTrades());
$('filter-outcome').addEventListener('change', ()=>renderTrades());

/* -------------------------
   Statistics calculations
   ------------------------- */
function updateStats(){
  const closed = state.trades.filter(t => t.exit_price !== null && t.exit_price !== undefined && t.status && t.status.startsWith('Closed'));
  const total = state.trades.length;
  const wins = closed.filter(t => safeNum(t.pnl,0) > 0);
  const losses = closed.filter(t => safeNum(t.pnl,0) < 0);
  const totalPnl = closed.reduce((s,t)=>s+safeNum(t.pnl,0),0);
  const avgWin = wins.length? wins.reduce((s,t)=>s+safeNum(t.pnl,0),0)/wins.length : 0;
  const avgLoss = losses.length? Math.abs(losses.reduce((s,t)=>s+safeNum(t.pnl,0),0)/losses.length) : 0;
  const profitFactor = avgLoss>0 ? (avgWin/avgLoss) : (avgWin>0?Infinity:0);
  const winrate = closed.length? (wins.length/closed.length)*100 : 0;
  const largestWin = wins.length? Math.max(...wins.map(t=>safeNum(t.pnl,0))) : 0;
  const largestLoss = losses.length? Math.min(...losses.map(t=>safeNum(t.pnl,0))) : 0;
  // expectancy: (win% * avgWin) - (loss% * avgLoss)
  const expectancy = closed.length ? ((wins.length/closed.length)*avgWin - (losses.length/closed.length)*avgLoss) : 0;

  $('stat-total').textContent = total;
  $('stat-winrate').textContent = winrate.toFixed(1)+'%';
  $('stat-totalpnl').textContent = formatMoney(totalPnl);
  $('stat-avgwin').textContent = formatMoney(avgWin);
  $('stat-avgloss').textContent = formatMoney(avgLoss);
  $('stat-profitfactor').textContent = (profitFactor===Infinity)?'∞':profitFactor.toFixed(2);
  $('stat-largestwin').textContent = formatMoney(largestWin);
  $('stat-largestloss').textContent = formatMoney(largestLoss);
  $('stat-expectancy').textContent = formatMoney(expectancy);
}

/* -------------------------
   Export / Import / CSV
   ------------------------- */
function exportJSON(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = `trade_journal_backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
  URL.revokeObjectURL(url);
}
function importJSONFile(file){
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const data = JSON.parse(e.target.result);
      if(!confirm('Importing will overwrite current data. Continue?')) return;
      state = data; saveData(state); renderAccounts(); renderTrades(); loadPlanUI(); loadProfitTargetUI(); updateStats(); updateProfitUI();
      alert('Imported');
    }catch(err){ alert('Import failed: '+err.message); }
  };
  reader.readAsText(file);
}
$('btn-export').addEventListener('click', exportJSON);
$('btn-import').addEventListener('click', ()=>$('import-file').click());
$('import-file').addEventListener('change', (e)=>{ const f = e.target.files[0]; if(f) importJSONFile(f); e.target.value=''; });

/* quick top buttons */
$('btn-export-json').addEventListener('click', exportJSON);
$('btn-import-json').addEventListener('click', ()=>$('import-file').click());

/* CSV export (trades) */
function exportCSV(){
  const rows = [['Date','Account','Symbol','Side','Qty','Entry','Exit','P&L','Status','Notes']];
  state.trades.forEach(t=>{
    const acc = state.accounts.find(a=>a.id===t.account_id);
    rows.push([t.date, acc?acc.name:'', t.symbol, t.side, t.quantity, t.entry_price, t.exit_price, safeNum(t.pnl,0), t.status, (t.notes||'').replace(/[\r\n]+/g,' ')]);
  });
  const csv = rows.map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = `trades_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
}
$('export-csv').addEventListener('click', exportCSV);

/* -------------------------
   Clear all data (danger)
   ------------------------- */
function clearAllData(){
  if(!confirm('This will remove ALL DATA (trades, accounts, plan, settings). Proceed?')) return;
  state = { accounts:[], trades:[], plan:{}, profitTarget:{ enabled:false, amount:0, period:'monthly' } };
  saveData(state); renderAccounts(); renderTrades(); loadPlanUI(); loadProfitTargetUI(); updateStats();
}
$('clear-data').addEventListener('click', clearAllData);

/* -------------------------
   Recalculate account balances from trades
   ------------------------- */
function recalcAccounts(){
  // set current_balance to starting then add closed trades
  state.accounts.forEach(acc=> acc.current_balance = safeNum(acc.starting_balance,0));
  state.trades.forEach(t=>{
    if(t.exit_price!==null && t.exit_price!==undefined){
      const acc = state.accounts.find(a=>a.id===t.account_id);
      if(acc) acc.current_balance = safeNum(acc.current_balance,0) + safeNum(t.pnl,0);
    }
  });
  saveData(state); renderAccounts(); updateStats();
}
$('btn-fix-bal').addEventListener('click', recalcAccounts);

/* -------------------------
   Initial render
   ------------------------- */
function init(){
  // ensure date default
  const dt = new Date(); dt.setMinutes(dt.getMinutes()-dt.getTimezoneOffset());
  $('trade-date').value = dt.toISOString().slice(0,16);

  renderAccounts(); renderTrades(); loadPlanUI(); loadProfitTargetUI(); updateStats(); updateProfitUI();
  // wire up other buttons
  $('btn-export-json').addEventListener('click', exportJSON);
  $('btn-import-json').addEventListener('click', ()=>$('import-file').click());
  $('btn-export').addEventListener('click', exportJSON);
  $('btn-import').addEventListener('click', ()=>$('import-file').click());
  $('btn-clear-accounts').addEventListener('click', clearAccounts);
  $('btn-export-csv',).addEventListener?.('click',exportCSV);
  $('btn-fix-bal').addEventListener('click', recalcAccounts);
  $('btn-clear-accounts').addEventListener('click', clearAccounts);
  // save/load profit target on page close / load
  window.addEventListener('beforeunload', ()=> saveData(state));
  // import file input also used by header import
  $('import-file').addEventListener('change', function(e){ if(e.target.files[0]) importJSONFile(e.target.files[0]); });
}
init();

/* renderTrades helper used earlier */
function renderTrades(){ // re-declare so it's hoisted with other helpers
  const tbody = document.querySelector('#trades-table tbody'); tbody.innerHTML = '';
  let rows = state.trades.slice();
  const fSymbol = $('filter-symbol').value.trim().toUpperCase();
  if(fSymbol) rows = rows.filter(r => (r.symbol||'').toUpperCase().includes(fSymbol));
  const fAcc = $('filter-account').value; if(fAcc) rows = rows.filter(r=>r.account_id===fAcc);
  const fOutcome = $('filter-outcome').value;
  if(fOutcome==='profit') rows = rows.filter(r=>safeNum(r.pnl,0)>0);
  if(fOutcome==='loss') rows = rows.filter(r=>safeNum(r.pnl,0)<0);
  if(fOutcome==='open') rows = rows.filter(r=>!(r.exit_price!==null && r.exit_price!==undefined));
  rows.forEach(t=>{
    const acc = state.accounts.find(a=>a.id===t.account_id);
    const tr = document.createElement('tr');
    const photosHtml = (t.photos||[]).slice(0,3).map(p=>`<img src="${p.data}" alt="${p.name}" style="width:28px;height:22px;object-fit:cover;border-radius:4px;margin-right:4px" />`).join('');
    tr.innerHTML = `<td>${new Date(t.date).toLocaleString()}</td>
      <td>${acc?acc.name:'Unknown'}</td>
      <td><strong>${t.symbol}</strong></td>
      <td>${t.side}</td>
      <td>${t.quantity}</td>
      <td>${t.entry_price!==null?t.entry_price:''}</td>
      <td>${t.exit_price!==null?t.exit_price:''}</td>
      <td class="${(t.pnl||0)>=0?'profit':'loss'}">${(t.pnl||0)>=0?'+':''}${(t.pnl||0).toFixed(2)}</td>
      <td class="tiny">${(t.notes||'').slice(0,100)}</td>
      <td>${photosHtml}</td>
      <td><button class="btn small" data-id="${t.id}" onclick="deleteTrade(event)">Del</button></td>`;
    tbody.appendChild(tr);
  });
  // populate account filter select
  const filterAcc = $('filter-account'); filterAcc.innerHTML = '<option value="">All accounts</option>';
  state.accounts.forEach(a=>filterAcc.insertAdjacentHTML('beforeend',`<option value="${a.id}">${a.name}</option>`));
}

</script>
</body>
</html>
